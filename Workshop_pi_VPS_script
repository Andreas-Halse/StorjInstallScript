#!/bin/bash
export DEBIAN_FRONTEND=noninteractive

# Update and install WireGuard
apt update -y && apt upgrade -y
apt install -y wireguard iptables-persistent net-tools curl

# Enable IP forwarding
sysctl -w net.ipv4.ip_forward=1
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf

# Generate WireGuard keys
mkdir -p /etc/wireguard
wg genkey | tee /etc/wireguard/private.key | wg pubkey > /etc/wireguard/public.key

PRIVATE_KEY=$(cat /etc/wireguard/private.key)
PUBLIC_KEY=$(cat /etc/wireguard/public.key)

# Hardcoded Raspberry Pi details
PI_PUBLIC_KEY="IsbG//9EUBMp6UuNjQbnkD0cvpSEdXoyZ1z7R3WeHgM="
PI_WG_IP="10.200.200.100"

# Get the unique WireGuard IP for this VPS from the argument
if [ -z "$1" ]; then
  echo "Usage: $0 <UniqueID>"
  exit 1
fi
UNIQUE_ID=$1
VPS_WG_IP="10.200.200.$UNIQUE_ID"

# Get the VPS public IP
VPS_PUBLIC_IP=$(curl -s https://api.ipify.org)

# Write WireGuard configuration
cat <<EOF > /etc/wireguard/wg0.conf
[Interface]
PrivateKey = $PRIVATE_KEY
Address = $VPS_WG_IP/24
ListenPort = 51820

# PostUp and PostDown NAT and forwarding rules
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -A FORWARD -o wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -D FORWARD -o wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

[Peer]
PublicKey = $PI_PUBLIC_KEY
AllowedIPs = $PI_WG_IP/32
EOF

# Enable and start WireGuard
systemctl enable wg-quick@wg0.service
systemctl start wg-quick@wg0.service

# Output necessary details
echo "VPS Public Key: $PUBLIC_KEY"
echo "VPS Public IP: $VPS_PUBLIC_IP"
echo "VPS WireGuard IP: $VPS_WG_IP"
echo "Share the VPS public key with the Raspberry Pi."
